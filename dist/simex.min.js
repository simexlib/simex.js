/**
 * @license
 * Copyright (c) 2015 Ninh Pham <nfam.dev@gmail.com>
 *
 * Use of this source code is governed by The MIT license.
 */
var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(factory){if("object"==typeof module&&"object"==typeof module.exports){var v=factory(require,exports);void 0!==v&&(module.exports=v)}else"function"==typeof define&&define.amd&&define(["require","exports"],factory)}(function(require,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ArrayExp=function(){function ArrayExp(json,processors){this.subexpressionType="array";try{if("object"!=typeof json||json instanceof Array||null===json)throw new AtError(messages.array);if(!json.hasOwnProperty("separator"))throw new AtError(messages.separatorMissing);switch(typeof json.separator){case"string":if(0===json.separator.length)throw new AtError(messages.separator,"separator");this.separator=json.separator;break;case"object":json.separator instanceof Array&&(json.separator.forEach(function(separator){if("string"!=typeof separator||0===separator.length)throw new AtError(messages.separator,"separator")}),this.separator=json.separator)}if(void 0===this.separator)throw new AtError(messages.separator,"separator");if(json.hasOwnProperty("skip")){switch(typeof json.skip){case"string":if("empty"!==json.skip&&"invalid"!==json.skip)throw new AtError(messages.skip,"skip");this.skip=json.skip;break;case"object":json.skip instanceof Array&&(json.skip.forEach(function(item){if("empty"!==item&&"invalid"!==item)throw new AtError(messages.skip,"skip")}),this.skip=json.skip)}if(void 0===this.skip)throw new AtError(messages.skip,"skip")}this.subexpression=paraseSubexpression(json,processors)}catch(error){throw addPrefixAt(error,"array"),error}}return ArrayExp.prototype.extract=function(input){var array=[];try{for(var parts=[input],separators="string"==typeof this.separator?[this.separator]:this.separator,_i=0,separators_1=separators;_i<separators_1.length;_i++){for(var separator=separators_1[_i],groups=[],ii=0;ii<parts.length;ii+=1)groups[ii]=parts[ii].split(separator);parts=[].concat.apply([],groups)}for(var skip="string"==typeof this.skip?[this.skip]:this.skip?this.skip:[],_a=0,parts_1=parts;_a<parts_1.length;_a++){var item=parts_1[_a];if(!(skip.indexOf("empty")>=0&&""===item))if(this.subexpression)try{var result=this.subexpression.extract(item);if(skip.indexOf("empty")>=0&&""===result)continue;array.push(result)}catch(error){if(skip.indexOf("invalid")<0)throw error}else array.push(item)}}catch(error){throw addPrefixAt(error,"array"),error}return array},ArrayExp.prototype.toJSON=function(){var json={separator:this.separator};return this.skip&&(json.skip=this.skip),this.subexpression&&(json[this.subexpression.subexpressionType]=this.subexpression.toJSON()),json},ArrayExp}(),AtError=function(_super){function AtError(message,at){var _this=_super.call(this,message)||this;return _this.at=at||"",_this}return __extends(AtError,_super),AtError}(Error);function addPrefixAt(error,prefix){"string"==typeof error.at&&"string"==typeof error.message&&""!==prefix&&(error.at=""!==error.at?prefix+"."+error.at:prefix)}function addMessageAt(error){"string"==typeof error.at&&"string"==typeof error.message&&""!==error.at&&(error.message+=" @ "+error.at)}var messages={array:'Property "array" must be an object.',backward:'Property "backward" must be boolean.',between:'Property "between" must be an object.',dictionary:'Property "dictionary" must be an object.',expression:"Expression must be an object.",has:'Property "has" must be a string.',member:"Member value of dictionary must be an object.",prefix:'Property "prefix" must be either a string or an array of strings.',process:'Property "process" must be a string in format "function[:args]", args is optional.',processUndefined:"Function is not found in processors.",required:'Property "required" must be boolean or a non-empty string.',separator:'Property "separator" must be either a non-empty string or an array of non-empty strings.',separatorMissing:'Property "separator" is missing.',skip:'Property "skip" must be either a string or an array of strings of "empty" or "invalid".',slice:'Property "slice" must be an object.',subexpressions:"Only one of slice, array, and dictionary shall be defined.",suffix:'Property "suffix" must be either a string or an array of strings.',trim:'Property "trim" must be boolean.',unmatch:"Provided input does not match the expression."},Between=function(){function Between(json){if("object"!=typeof json||json instanceof Array||null===json)throw new AtError(messages.between,"between");if(json.hasOwnProperty("backward")){if("boolean"!=typeof json.backward)throw new AtError(messages.backward,"between.backward");this.backward=json.backward}if(json.hasOwnProperty("prefix")){switch(typeof json.prefix){case"string":this.prefix=json.prefix;break;case"object":json.prefix instanceof Array&&(json.prefix.forEach(function(prefix){if("string"!=typeof prefix)throw new AtError(messages.prefix,"between.prefix")}),this.prefix=json.prefix)}if(void 0===this.prefix)throw new AtError(messages.prefix,"between.prefix")}if(json.hasOwnProperty("suffix")){switch(typeof json.suffix){case"string":this.suffix=json.suffix;break;case"object":json.suffix instanceof Array&&(json.suffix.forEach(function(suffix){if("string"!=typeof suffix)throw new AtError(messages.suffix,"between.suffix")}),this.suffix=json.suffix)}if(void 0===this.suffix)throw new AtError(messages.suffix,"between.suffix")}if(json.hasOwnProperty("trim")){if("boolean"!=typeof json.trim)throw new AtError(messages.trim,"between.trim");this.trim=json.trim}}return Between.prototype.extract=function(input){for(var str=input,prefixes=void 0===this.prefix?[]:"string"==typeof this.prefix?[this.prefix]:this.prefix,index=0;index<prefixes.length;index+=1){var prefix=prefixes[index];if(prefix.length>0)if(this.backward){if(!((end=str.lastIndexOf(prefix))>=0)){var location_1="string"==typeof this.prefix?"between.prefix":"between.prefix."+prefix+"("+index+")";throw new AtError(messages.unmatch,location_1)}str=str.substring(0,end)}else{if(!((start=str.indexOf(prefix))>=0)){var location_2="string"==typeof this.prefix?"between.prefix":"between.prefix."+prefix+"("+index+")";throw new AtError(messages.unmatch,location_2)}str=str.substring(start+prefix.length)}}for(var suffixed=!1,suffixesCount=0,_i=0,suffixes_1=void 0===this.suffix?[]:"string"==typeof this.suffix?[this.suffix]:this.suffix;_i<suffixes_1.length;_i++){var start,end,suffix=suffixes_1[_i];if(suffixesCount+=1,!(suffix.length>0)){suffixed=!0;break}if(this.backward){if((start=str.lastIndexOf(suffix))>=0){str=str.substring(start+suffix.length),suffixed=!0;break}}else if((end=str.indexOf(suffix))>=0){str=str.substring(0,end),suffixed=!0;break}}if(!suffixed&&suffixesCount>0)throw new AtError(messages.unmatch,"between.suffix");return this.trim&&(str=str.trim()),str},Between.prototype.toJSON=function(){var json={};return void 0!==this.backward&&(json.backward=this.backward),void 0!==this.prefix&&(json.prefix=this.prefix),void 0!==this.suffix&&(json.suffix=this.suffix),void 0!==this.trim&&(json.trim=this.trim),json},Between}(),Dictionary=function(){function Dictionary(json,processors){var _this=this;this.subexpressionType="dictionary";try{if("object"!=typeof json||json instanceof Array||null===json)throw new AtError(messages.dictionary);this.members={},Object.keys(json).forEach(function(name){var value=json[name];if("object"!=typeof value||value instanceof Array)throw new AtError(messages.member,name);try{_this.members[name]=new Slice(value,processors,"member")}catch(error){throw addPrefixAt(error,name),error}})}catch(error){throw addPrefixAt(error,"dictionary"),error}}return Dictionary.prototype.extract=function(input){for(var dictionary={},errors={},_i=0,names_1=Object.keys(this.members);_i<names_1.length;_i++){var name_1=names_1[_i],member=this.members[name_1];try{dictionary[name_1]=member.extract(input),"string"==typeof member.required&&(errors[member.required]=void 0)}catch(error){if(void 0===member.required||member.required){if("string"!=typeof member.required)throw addPrefixAt(error,"dictionary."+name_1),error;member.required in errors||(addPrefixAt(error,"dictionary."+name_1+"("+member.required+")"),errors[member.required]=error)}}}for(var _a=0,requireds_1=Object.keys(errors);_a<requireds_1.length;_a++){var required=requireds_1[_a],error=errors[required];if(void 0!==error)throw error}return dictionary},Dictionary.prototype.toJSON=function(){var _this=this,json={};return Object.keys(this.members).forEach(function(name){json[name]=_this.members[name].toJSON()}),json},Dictionary}(),Expression=function(){function Expression(json,processors){processors=processors||{};try{this.expression=new Slice(json,processors,"root")}catch(error){throw addMessageAt(error),error}}return Expression.prototype.extract=function(input){try{return function avoidMemoryLeak(item){if("string"==typeof item)item=(" "+item).substring(1);else if("object"==typeof item)if(item instanceof Array)for(var i=0;i<item.length;i+=1)item[i]=avoidMemoryLeak(item[i]);else Object.keys(item).forEach(function(key){item[key]=avoidMemoryLeak(item[key])});return item}(this.expression.extract(input))}catch(error){throw addMessageAt(error),error}},Expression.prototype.toJSON=function(){return this.expression.toJSON()},Expression}();function paraseSubexpression(json,processors){if(json.hasOwnProperty("slice")){if(json.hasOwnProperty("array")||json.hasOwnProperty("dictionary"))throw new AtError(messages.subexpressions);return new Slice(json.slice,processors,"slice")}if(json.hasOwnProperty("array")){if(json.hasOwnProperty("dictionary"))throw new AtError(messages.subexpressions);return new ArrayExp(json.array,processors)}if(json.hasOwnProperty("dictionary"))return new Dictionary(json.dictionary,processors)}exports.Expression=Expression;var Process=function(){function Process(json,processors){if("string"!=typeof json)throw new AtError(messages.process,"process");var value=json.trim(),index=value.indexOf(":");if(index<0?(this.name=value,this.args=void 0):(this.name=value.substring(0,index),this.args=value.substring(index+1).trim()),this.func=processors[this.name],!this.func)throw new AtError(messages.processUndefined,"process("+this.name+")")}return Process.prototype.extract=function(input){try{return this.func(input,this.args)}catch(e){var error=new AtError(messages.unmatch,"process");throw e.stack&&(error.stack=e.stack),error}},Process.prototype.toJSON=function(){return void 0!==this.args?this.name+":"+this.args:this.name},Process}(),Slice=function(){function Slice(json,processors,type){this.subexpressionType="slice",this.sliceType=type;try{if("object"!=typeof json||json instanceof Array||null===json)throw new AtError("root"==this.sliceType?messages.expression:"member"==this.sliceType?messages.member:messages.slice);if("member"===type&&json.hasOwnProperty("required")){if("boolean"!=typeof json.required&&("string"!=typeof json.required||0===json.required.length))throw new AtError(messages.required,"required");this.required=json.required}if(json.hasOwnProperty("has")){if("string"!=typeof json.has)throw new AtError(messages.has,"has");this.has=json.has}json.hasOwnProperty("between")&&(this.between=new Between(json.between)),json.hasOwnProperty("process")&&(this.process=new Process(json.process,processors)),this.subexpression=paraseSubexpression(json,processors)}catch(error){throw"slice"==this.sliceType&&addPrefixAt(error,"slice"),error}}return Slice.prototype.extract=function(input){try{if(this.has&&this.has.length>0&&input.indexOf(this.has)<0)throw new AtError(messages.unmatch,"has");var str=input;this.between&&(str=this.between.extract(str)),this.process&&(str=this.process.extract(str));var result=str;return this.subexpression&&(result=this.subexpression.extract(str)),result}catch(error){throw"slice"==this.sliceType&&addPrefixAt(error,"slice"),error}},Slice.prototype.toJSON=function(){var json={};return void 0!==this.required&&(json.required=this.required),void 0!==this.has&&(json.has=this.has),void 0!==this.between&&(json.between=this.between.toJSON()),void 0!==this.process&&(json.process=this.process.toJSON()),this.subexpression&&(json[this.subexpression.subexpressionType]=this.subexpression.toJSON()),json},Slice}()});